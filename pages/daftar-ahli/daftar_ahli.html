<!DOCTYPE html>
<html lang="ms">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar Ahli - The Strata</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="daftar_ahli.css">
</head>

<body>
    <main>
        <!-- Logo Header -->
        <div class="header-logo">
            <a href="../../index.html">
                <img src="../../partial/persatuan-penduduk-the-strata-bandar-puteri-bangi.png" alt="The Strata Logo">
            </a>
        </div>

        <!-- Registration Form Section -->
        <section class="registration-section">
            <div class="container">
                <div class="registration-content">
                    <h2>BORANG PENDAFTARAN AHLI</h2>
                    <p>Sila isi borang pendaftaran berikut untuk menjadi ahli Persatuan Penduduk The Strata Bandar
                        Puteri Bangi.</p>

                    <!-- Error/Success Message -->
                    <div id="messageBox" class="message-box" style="display: none;"></div>

                    <button class="btn-view-terms" id="openTermsBtn">
                        LIHAT SYARAT PENDAFTARAN
                    </button>

                    <form class="registration-form" id="registrationForm">
                        <!-- Section A: Maklumat Ahli -->
                        <div class="form-section">
                            <h3>A. MAKLUMAT AHLI</h3>

                            <div class="form-group">
                                <label for="nama">NAMA PENUH *</label>
                                <input type="text" id="nama" name="nama" placeholder="Contoh: Muhammad Ali Bin Ibrahim">
                            </div>

                            <div class="form-group">
                                <label for="kp">NO. K/P *</label>
                                <input type="text" id="kp" name="kp" placeholder="Contoh: 123456-12-1234">
                            </div>

                            <div class="form-group">
                                <label for="bangsa">BANGSA *</label>
                                <input type="text" id="bangsa" name="bangsa" placeholder="Contoh: Melayu / Cina / India">
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="no_rumah">NO. RUMAH *</label>
                                    <input type="text" id="no_rumah" name="no_rumah" placeholder="Contoh: 1-2A">
                                </div>
                                <div class="form-group">
                                    <label for="jalan_puteri">JALAN PUTERI *</label>
                                    <input type="text" id="jalan_puteri" name="jalan_puteri"
                                        placeholder="Contoh: Jalan Puteri 3/1">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="hp">NO. H/P *</label>
                                <input type="tel" id="hp" name="hp" placeholder="Contoh: 012-3456789">
                            </div>

                            <div class="form-group">
                                <label>STATUS AHLI *</label>
                                <div class="checkbox-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="status_ahli" value="pemilik">
                                        PEMILIK / AHLI KELUARGA PEMILIK
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="status_ahli" value="penyewa">
                                        PENYEWA
                                    </label>
                                </div>
                                <p class="form-note">Sila tandakan pada ✓ pada kotak yang berkaitan.</p>
                            </div>
                        </div>

                        <!-- Section B: Maklumat Isirumah -->
                        <div class="form-section">
                            <h3>B. MAKLUMAT ISIRUMAH</h3>
                            <p class="form-note">Nota: Bagi ruangan status/hubungan, sila nyatakan sama ada
                                suami/isteri/anak/bapa/emak/dll.</p>

                            <div class="table-wrapper">
                                <table class="form-table" id="isirumahTable">
                                    <thead>
                                        <tr>
                                            <th>BIL</th>
                                            <th>NAMA PENUH</th>
                                            <th>STATUS / HUBUNGAN</th>
                                            <th>NO.TEL</th>
                                            <th>AKSI</th>
                                        </tr>
                                    </thead>
                                    <tbody id="isirumahTableBody">
                                        <tr class="table-row">
                                            <td class="row-number">1.</td>
                                            <td><input type="text" name="isirumah_nama[]" class="isirumah-input"
                                                    placeholder="Nama penuh"></td>
                                            <td><input type="text" name="isirumah_status[]" class="isirumah-input"
                                                    placeholder="Contoh: Isteri / Anak"></td>
                                            <td><input type="text" name="isirumah_tel[]" class="isirumah-input"
                                                    placeholder="012-3456789"></td>
                                            <td class="action-cell">
                                                <button type="button" class="btn-remove-row"
                                                    style="display:none;">✕</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                                <button type="button" class="btn-add-row" id="addIsirumahRow">
                                    <i class="fa-solid fa-plus"></i> TAMBAH BARIS
                                </button>
                            </div>
                        </div>

                        <!-- Section C: Maklumat Kenderaan -->
                        <div class="form-section">
                            <h3>C. MAKLUMAT KENDERAAN</h3>

                            <div class="table-wrapper">
                                <table class="form-table" id="kenderaanTable">
                                    <thead>
                                        <tr>
                                            <th>BIL</th>
                                            <th>JENIS KENDERAAN / MODEL</th>
                                            <th>NO. PENDAFTARAN</th>
                                            <th>NO. PELEKAT</th>
                                            <th>AKSI</th>
                                        </tr>
                                    </thead>
                                    <tbody id="kenderaanTableBody">
                                        <tr class="table-row">
                                            <td class="row-number">1.</td>
                                            <td><input type="text" name="kenderaan_jenis[]" class="kenderaan-input"
                                                    placeholder="Contoh: Honda Civic 2020"></td>
                                            <td><input type="text" name="kenderaan_no[]" class="kenderaan-input"
                                                    placeholder="WXY 1234"></td>
                                            <td><input type="text" name="kenderaan_pelekat[]" class="kenderaan-input"
                                                    placeholder="Contoh: TSP001"></td>
                                            <td class="action-cell">
                                                <button type="button" class="btn-remove-row"
                                                    style="display:none;">✕</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                                <button type="button" class="btn-add-row" id="addKenderaanRow">
                                    <i class="fa-solid fa-plus"></i> TAMBAH BARIS
                                </button>
                            </div>
                        </div>

                        <!-- Section D: Bukti Kelayakan -->
                        <div class="form-section">
                            <h3>D. BUKTI KELAYAKAN</h3>
                            <p class="form-note">Sila kemukakan salinan muka hadapan Perjanjian Jual Beli / Kontrak
                                Sewaan (yang mana berkaitan) sebagai bukti kelayakan menyertai persatuan.</p>

                            <div class="form-group">
                                <label>MUAT NAIK DOKUMEN *</label>
                                <div class="file-upload-wrapper">
                                    <input type="file" id="bukti_kelayakan" name="bukti_kelayakan"
                                        accept=".pdf,.jpg,.jpeg,.png">
                                    <label for="bukti_kelayakan" class="file-upload-label">
                                        <i class="fa-solid fa-cloud-arrow-up"></i>
                                        <p>Klik untuk memilih fail atau tarik dan lepas</p>
                                        <span class="file-types">Format yang dibenarkan: PDF, JPG, PNG (Maksimum
                                            5MB)</span>
                                    </label>
                                    <div class="file-name-display"></div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group terms-checkbox">
                            <label>
                                <input type="checkbox" name="terms" id="termsCheckbox">
                                Saya bersetuju dengan syarat dan ketentuan pendaftaran
                            </label>
                        </div>

                        <button type="submit" class="btn-submit" id="submitBtn">
                            <i class="fa-solid fa-paper-plane"></i> HANTAR PENDAFTARAN
                        </button>
                    </form>


                </div>
            </div>
        </section>
    </main>

    <!-- Success Modal -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <div class="modal-body success-body">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h2>PENDAFTARAN BERJAYA</h2>
                <p>Terima kasih telah mendaftar sebagai ahli Persatuan Penduduk The Strata Bandar Puteri Bangi.</p>
                <div class="success-message">
                    <p><strong>Akaun anda telah berjaya dicipta!</strong></p>
                    <p>Sila tunggu selama 5 hari bekerja untuk pengesahan permohonan anda.</p>
                    <p>Pautan pembayaran yuran pendaftaran dan tahunan akan dihantar ke alamat e-mel anda.</p>
                </div>
                <button class="btn-submit" id="okBtn">LOG MASUK SEKARANG</button>
            </div>
        </div>
    </div>

    <!-- Terms Modal -->
    <div id="termsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>SYARAT PENDAFTARAN</h2>
                <button class="modal-close" id="closeTermsBtn">&times;</button>
            </div>
            <div class="modal-body">
                <ul class="terms-list">
                    <li>TERBUKA KEPADA PEMILIK ATAU PENYEWA RUMAH DI THE STRATA BANDAR PUTERI BANGI YANG BERUMUR 18
                        TAHUN KE ATAS DAN WARGANEGARA MALAYSIA.</li>
                    <li>MAKSIMUM DUA (2) KEAHLIAN DIBERIKAN BAGI SETIAP UNIT KEDIAMAN PADA SATU MASA.</li>
                    <li>PERMOHONAN KEAHLIAN AKAN DILULUSKAN SELEPAS BAYARAN PENDAFTARAN DAN YURAN TAHUNAN DIJELASKAN.
                    </li>
                    <li>MAKLUMAT PERIBADI YANG DIKUMPUL ADALAH UNTUK TUJUAN PENGESAHAN DAN KESELAMATAN SAHAJA.</li>
                </ul>

                <div class="terms-fees">
                    <p><strong>YURAN PENDAFTARAN: RM 20.00</strong></p>
                    <p><strong>YURAN TAHUNAN: RM 20.00</strong></p>
                </div>

                <ul class="terms-list">
                    <li>SILA SEDIAKAN SALINAN PERJANJIAN JUAL BELI ATAU KONTRAK SEWAAN SEBAGAI BUKTI KELAYAKAN.</li>
                    <li>BORANG YANG LENGKAP DAN SLIP BAYARAN BOLEH DISERAHKAN KEPADA KETUA LORONG ATAU PIHAK YANG
                        DITAPAKAN.</li>
                </ul>

                <button class="btn-submit" id="acceptTermsBtn">
                    TERUSKAN <i class="fa-solid fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <p>Sila tunggu...</p>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- Firebase Config -->
    <script src="../../js/firebase-config.js"></script>

    <!-- Registration Script -->
    <script>
        // DOM Elements
        const registrationForm = document.getElementById('registrationForm');
        const messageBox = document.getElementById('messageBox');
        const successModal = document.getElementById('successModal');
        const termsModal = document.getElementById('termsModal');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const okBtn = document.getElementById('okBtn');
        const openTermsBtn = document.getElementById('openTermsBtn');
        const closeTermsBtn = document.getElementById('closeTermsBtn');
        const acceptTermsBtn = document.getElementById('acceptTermsBtn');
        const submitBtn = document.getElementById('submitBtn');

        // Toggle password visibility
        function togglePassword(inputId, iconId) {
            const passwordField = document.getElementById(inputId);
            const toggleIcon = document.getElementById(iconId);

            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordField.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }

        // Show message
        function showMessage(message, isError = true) {
            messageBox.textContent = message;
            messageBox.className = 'message-box ' + (isError ? 'error' : 'success');
            messageBox.style.display = 'block';
            messageBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Show/hide loading
        function showLoading(show) {
            loadingOverlay.style.display = show ? 'flex' : 'none';
            submitBtn.disabled = show;
        }

        // Terms modal handlers
        openTermsBtn.addEventListener('click', () => {
            termsModal.style.display = 'flex';
        });

        closeTermsBtn.addEventListener('click', () => {
            termsModal.style.display = 'none';
        });

        acceptTermsBtn.addEventListener('click', () => {
            document.getElementById('termsCheckbox').checked = true;
            termsModal.style.display = 'none';
        });

        // Add row functionality for tables
        let isirumahRowCount = 1;
        let kenderaanRowCount = 1;

        document.getElementById('addIsirumahRow').addEventListener('click', function () {
            isirumahRowCount++;
            const tbody = document.getElementById('isirumahTableBody');
            const newRow = document.createElement('tr');
            newRow.className = 'table-row';
            newRow.innerHTML = `
                <td class="row-number">${isirumahRowCount}.</td>
                <td><input type="text" name="isirumah_nama[]" class="isirumah-input" placeholder="Nama penuh"></td>
                <td><input type="text" name="isirumah_status[]" class="isirumah-input" placeholder="Contoh: Isteri / Anak"></td>
                <td><input type="text" name="isirumah_tel[]" class="isirumah-input" placeholder="012-3456789"></td>
                <td class="action-cell">
                    <button type="button" class="btn-remove-row" onclick="removeRow(this, 'isirumah')">✕</button>
                </td>
            `;
            tbody.appendChild(newRow);
        });

        document.getElementById('addKenderaanRow').addEventListener('click', function () {
            kenderaanRowCount++;
            const tbody = document.getElementById('kenderaanTableBody');
            const newRow = document.createElement('tr');
            newRow.className = 'table-row';
            newRow.innerHTML = `
                <td class="row-number">${kenderaanRowCount}.</td>
                <td><input type="text" name="kenderaan_jenis[]" class="kenderaan-input" placeholder="Contoh: Honda Civic 2020"></td>
                <td><input type="text" name="kenderaan_no[]" class="kenderaan-input" placeholder="WXY 1234"></td>
                <td><input type="text" name="kenderaan_pelekat[]" class="kenderaan-input" placeholder="Contoh: TSP001"></td>
                <td class="action-cell">
                    <button type="button" class="btn-remove-row" onclick="removeRow(this, 'kenderaan')">✕</button>
                </td>
            `;
            tbody.appendChild(newRow);
        });

        function removeRow(btn, type) {
            btn.closest('tr').remove();
            // Update row numbers
            const tbody = document.getElementById(type === 'isirumah' ? 'isirumahTableBody' : 'kenderaanTableBody');
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                row.querySelector('.row-number').textContent = (index + 1) + '.';
            });
            if (type === 'isirumah') isirumahRowCount = rows.length;
            else kenderaanRowCount = rows.length;
        }

        // File upload display
        document.getElementById('bukti_kelayakan').addEventListener('change', function (e) {
            const fileName = e.target.files[0]?.name;
            const display = document.querySelector('.file-name-display');
            if (fileName) {
                display.innerHTML = `<i class="fa-solid fa-file"></i> ${fileName}`;
                display.style.display = 'block';
            }
        });

        // Collect household data
        function getIsirumahData() {
            const rows = document.querySelectorAll('#isirumahTableBody tr');
            const data = [];
            rows.forEach(row => {
                const nama = row.querySelector('input[name="isirumah_nama[]"]')?.value;
                const status = row.querySelector('input[name="isirumah_status[]"]')?.value;
                const tel = row.querySelector('input[name="isirumah_tel[]"]')?.value;
                if (nama) {
                    data.push({ nama, status, tel });
                }
            });
            return data;
        }

        // Collect vehicle data
        function getKenderaanData() {
            const rows = document.querySelectorAll('#kenderaanTableBody tr');
            const data = [];
            rows.forEach(row => {
                const jenis = row.querySelector('input[name="kenderaan_jenis[]"]')?.value;
                const no = row.querySelector('input[name="kenderaan_no[]"]')?.value;
                const pelekat = row.querySelector('input[name="kenderaan_pelekat[]"]')?.value;
                if (jenis) {
                    data.push({ jenis, no, pelekat });
                }
            });
            return data;
        }

        // Initialize Firebase Storage
        const storage = firebase.storage();

        // Update loading message
        function updateLoadingMessage(message) {
            const loadingText = document.querySelector('.loading-overlay p');
            if (loadingText) {
                loadingText.textContent = message;
            }
        }

        // Upload document to Firebase Storage with progress
        async function uploadDocument(file, userId) {
            if (!file) return null;

            return new Promise((resolve, reject) => {
                try {
                    // Create a unique file name
                    const timestamp = Date.now();
                    const fileExtension = file.name.split('.').pop();
                    const fileName = `bukti_kelayakan/${userId}/${timestamp}.${fileExtension}`;

                    // Create storage reference
                    const storageRef = storage.ref(fileName);
                    const uploadTask = storageRef.put(file);

                    // Set timeout (60 seconds)
                    const timeout = setTimeout(() => {
                        uploadTask.cancel();
                        reject(new Error('Upload timeout - fail terlalu besar atau internet perlahan'));
                    }, 60000);

                    // Monitor upload progress
                    uploadTask.on('state_changed',
                        (snapshot) => {
                            const progress = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
                            updateLoadingMessage(`Memuat naik dokumen... ${progress}%`);
                        },
                        (error) => {
                            clearTimeout(timeout);
                            console.error('Upload error:', error);
                            reject(error);
                        },
                        async () => {
                            clearTimeout(timeout);
                            // Upload completed successfully
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            updateLoadingMessage('Menyimpan data...');
                            resolve({
                                url: downloadURL,
                                fileName: file.name,
                                fileType: file.type,
                                uploadedAt: new Date().toISOString()
                            });
                        }
                    );
                } catch (error) {
                    console.error('Error uploading document:', error);
                    reject(error);
                }
            });
        }

        // Form submission
        registrationForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Get form values
            const nama = document.getElementById('nama').value.trim();
            const kp = document.getElementById('kp').value.trim();
            const bangsa = document.getElementById('bangsa').value.trim();
            const noRumah = document.getElementById('no_rumah').value.trim();
            const jalanPuteri = document.getElementById('jalan_puteri').value.trim();
            const hp = document.getElementById('hp').value.trim();
            const termsChecked = document.getElementById('termsCheckbox').checked;
            const buktiFile = document.getElementById('bukti_kelayakan').files[0];

            // Validation - only check required fields that exist
            if (!nama || !kp) {
                showMessage('Sila lengkapkan semua ruangan yang diperlukan.');
                return;
            }

            if (!termsChecked) {
                showMessage('Sila bersetuju dengan syarat dan ketentuan pendaftaran.');
                return;
            }

            // Validate file if uploaded
            if (buktiFile) {
                const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
                const maxSize = 5 * 1024 * 1024; // 5MB

                if (!allowedTypes.includes(buktiFile.type)) {
                    showMessage('Format fail tidak dibenarkan. Sila muat naik PDF, JPG, atau PNG sahaja.');
                    return;
                }

                if (buktiFile.size > maxSize) {
                    showMessage('Saiz fail terlalu besar. Maksimum 5MB dibenarkan.');
                    return;
                }
            }

            // Get status ahli
            const statusAhli = [];
            document.querySelectorAll('input[name="status_ahli"]:checked').forEach(cb => {
                statusAhli.push(cb.value);
            });

            showLoading(true);

            try {
                // First, create the user account
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Upload document if provided
                let buktiKelayakan = null;
                if (buktiFile) {
                    try {
                        buktiKelayakan = await uploadDocument(buktiFile, user.uid);
                    } catch (uploadError) {
                        console.error('Document upload failed:', uploadError);
                        // Continue without document if upload fails
                    }
                }

                // Prepare user data
                const userData = {
                    email: email,
                    nama: nama,
                    kp: kp,
                    bangsa: bangsa,
                    alamat: {
                        noRumah: noRumah,
                        jalanPuteri: jalanPuteri
                    },
                    hp: hp,
                    statusAhli: statusAhli,
                    isirumah: getIsirumahData(),
                    kenderaan: getKenderaanData(),
                    buktiKelayakan: buktiKelayakan,
                    status: 'pending',
                    verified: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    role: 'member'
                };

                // Save user data to Firestore
                await db.collection('users').doc(user.uid).set(userData);

                showLoading(false);
                successModal.style.display = 'flex';

            } catch (error) {
                showLoading(false);
                showMessage(getErrorMessage(error.code) || 'Ralat berlaku. Sila cuba lagi.');
            }
        });

        // OK button - redirect to login
        okBtn.addEventListener('click', () => {
            window.location.href = '../login/login.html';
        });

        // Close modals on outside click
        window.addEventListener('click', (e) => {
            if (e.target === termsModal) {
                termsModal.style.display = 'none';
            }
        });
    </script>
</body>

</html>